<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#4A90E2">
  <title>Contador de Inventário Granel</title>

  <!-- Tailwind + FontAwesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <link rel="manifest" href="manifest.json">

  <style>
    @keyframes flash{0%,100%{background:initial}50%{background:#a7f3d0}}
    .flash-success{animation:flash .5s}
    @keyframes flash-error{0%,100%{background:initial}50%{background:#fecaca}}
    .flash-error{animation:flash-error .7s}
    #listaItensTable{width:100%;table-layout:fixed;font-size:.9rem}
    #listaItensTable th,#listaItensTable td{padding:6px 4px;border:1px solid #e5e7eb}
    #installPwaButton{display:none}
    .tara-button{padding:.5rem .75rem;font-weight:600;border:1px solid #6b7280;border-radius:.375rem;background:#f3f4f6;margin:.25rem;cursor:pointer}
    .tara-button.selected{background:#3b82f6;color:#fff;border-color:#2563eb}
    #statusEnvio{display:none;text-align:center;padding:.5rem;border-radius:.375rem;font-weight:500}
    #statusEnvio.success{background:#d1fae5;color:#065f46;display:block}
    #statusEnvio.error{background:#fee2e2;color:#991b1b;display:block}
    #statusEnvio.sending{background:#e0e7ff;color:#3730a3;display:block}
  </style>
</head>

<body class="bg-gray-100 font-sans p-2 sm:p-4">

  <!-- MODAL NOME -->
  <div id="overlayNomeUsuario" class="fixed inset-0 bg-black/60 z-40 hidden"></div>
  <div id="modalNomeUsuario"
       class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded shadow z-50 hidden">
    <h2 class="text-lg font-semibold mb-4">Identificação</h2>
    <input id="inputNomeUsuario" placeholder="Seu nome"
           class="w-full p-2 border rounded mb-4">
    <button id="salvarNomeUsuarioBtn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">
      Salvar
    </button>
  </div>

  <!-- CONTAINER -->
  <div class="mx-auto max-w-2xl bg-white p-4 sm:p-6 rounded shadow">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold flex-grow text-center">Contador de Inventário Granel</h1>
      <span id="nomeUsuarioDisplay"
            class="text-sm text-blue-600 font-medium cursor-pointer whitespace-nowrap"></span>
    </div>

    <div class="text-center mb-4">
      <button id="installPwaButton"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-flex items-center">
        <i class="fas fa-download mr-2"></i>Instalar App
      </button>
    </div>

    <!-- FORM -->
    <div class="space-y-4">
      <div>
        <label for="codigoProduto" class="block text-sm font-medium">Código do Produto:</label>
        <input id="codigoProduto" class="w-full p-2 border rounded" placeholder="Código">
        <div id="nomeProdutoDisplay" class="italic text-blue-800 mt-1"></div>
      </div>

      <div>
        <label class="block text-sm font-medium">
          Selecionar Tara Rápida (Pote): <span id="letraPoteSelecionado" class="font-bold"></span>
        </label>
        <div id="botoesTaraContainer" class="flex flex-wrap justify-center">
          <button class="tara-button" data-tara-kg="0.258" data-letra="A">A</button>
          <button class="tara-button" data-tara-kg="0.410" data-letra="B">B</button>
          <button class="tara-button" data-tara-kg="0.322" data-letra="C">C</button>
          <button class="tara-button" data-tara-kg="0.586" data-letra="D">D</button>
          <button class="tara-button" data-tara-kg="0.750" data-letra="E">E</button>
          <button class="tara-button" data-tara-kg="0"     data-letra="Nenhuma">Nenhuma</button>
        </div>
      </div>

      <div>
        <label for="pesoTaraKg" class="block text-sm font-medium">Peso do Pote/Tara (kg):</label>
        <input id="pesoTaraKg" type="number" step="0.001" class="w-full p-2 border rounded">
      </div>

      <div>
        <label for="pesoTotalKg" class="block text-sm font-medium">Peso Total na Balança (kg):</label>
        <input id="pesoTotalKg" type="number" step="0.001" class="w-full p-2 border rounded">
      </div>

      <div id="statusEnvio"></div>

      <button id="registrarItemBtn"
              class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded disabled:opacity-50"
              disabled>
        <i class="fas fa-cloud-upload-alt mr-2"></i>Registrar e Enviar
      </button>
    </div>

    <!-- LISTA LOCAL -->
    <div class="mt-8 opacity-60">
      <h2 class="font-semibold mb-2">Registros Locais (Temporário):</h2>
      <div class="overflow-x-auto max-h-40 border rounded">
        <table id="listaItensTable" class="min-w-full">
          <thead class="bg-gray-50 sticky top-0">
            <tr><th>Código</th><th>Peso Líq.</th><th>Tara</th><th>Data/Hora</th><th>Ação</th></tr>
          </thead>
          <tbody id="listaItensBody">
            <tr><td colspan="5" class="text-center text-gray-500 py-4">Nenhum item local.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-3 mt-4">
      <button id="limparSessaoLocalBtn"
              class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded">
        Limpar Registros Locais
      </button>
      <button id="alterarNomeBtn"
              class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded">
        Alterar Nome
      </button>
    </div>
  </div>

  <script src="app.js"></script>

  <!-- SERVICE-WORKER + BOTÃO INSTALAR -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js', { scope:'./' });
    }
    let deferredPrompt, installBtn = document.getElementById('installPwaButton');
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-flex';
    });
    installBtn.addEventListener('click',async()=>{
      installBtn.style.display='none'; deferredPrompt.prompt(); deferredPrompt=null;
    });
  </script>
</body>
</html>
